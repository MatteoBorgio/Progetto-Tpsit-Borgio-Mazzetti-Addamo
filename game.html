<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il gioco del cento</title>
    <link rel="stylesheet" href="game.css">
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            padding: 10px;
            padding-left: 20px;
        }

        .casella {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: black;
            margin-left: 20px;
            border-radius: 5px;
            text-align: center;
            line-height: 50px;
            font-size: 20px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Il gioco del cento</h1>
    </div>
    <script>
        const parametri = new URLSearchParams(window.location.search);
        const difficoltà = parametri.get('difficulty')
        let grandezzaMatrice = 0;
        let caselleCliccate = new Array();
        let counter = 1;

        if (difficoltà === 'easy') {
            grandezzaMatrice = 5;
        }
        else if (difficoltà === 'medium') {
            grandezzaMatrice = 7;
        }
        else {
            grandezzaMatrice = 10;
        }

        // Funzione per creare la matrice che rappresenterà la nostra griglia di gioco
        function creaMatrice(grandezzaMatrice) {
            let matrice = new Array();
            const container = document.getElementById("container");
            for (let i = 0; i < grandezzaMatrice; i++) {
                matrice[i] = new Array();
                for (let j = 0; j < grandezzaMatrice; j++) {
                    let casella = document.createElement("div");
                    casella.setAttribute('class', 'casella');
                    matrice[i][j] = casella; 
                    container.appendChild(matrice[i][j]);
                    // Posizionamento dinamico delle caselle, in base alla posizione della casella precendente
                    let x = (i * 55) + 130;
                    let y = (j * 55) + 10;
                    matrice[i][j].style.top = x + "px"; 
                    matrice[i][j].style.left = y + "px";
                    matrice[i][j].style.position = "absolute";
                }
            }
            return matrice;
        }
        
        // Funzione che colora le caselle disponibili per la mossa
        function mostraMossePossibili(casella, matrice, caselleCliccate) {
            caselleCliccate.push(casella); // Aggiunge la casella cliccata all'array delle caselle cliccate
            casella.textContent = counter; // Aggiunge il numero della mossa alla casella cliccata
            counter++;
            for (let i = 0; i < matrice.length; i++) { // Rimuove il colore dalle caselle precedentemente colorate
                for (let j = 0; j < matrice.length; j++) {
                    matrice[i][j].style.backgroundColor = "black";
                }
                for (let k = 0; k < caselleCliccate.length; k++) { // Colora di blu le caselle già cliccate
                    caselleCliccate[k].style.backgroundColor = "blue";
                }
            }
            let x = Infinity;
            let y = Infinity;
            for (let i = 0; i < matrice.length; i++) { // Trova la posizione della casella cliccata all'interno della matrice
                for (let j = 0; j < matrice.length; j++) {
                    if (matrice[i][j] === casella) {
                        x = i;
                        y = j;
                    }
                }
                let mossePossibili = [ //miao
                    [x - 3, y],
                    [x + 3, y],
                    [x, y - 3],
                    [x, y + 3],
                    [x - 2, y - 2],
                    [x - 2, y + 2],
                    [x + 2, y - 2],
                    [x + 2, y + 2],
                ];
                // Trova e rimuove le mosse che eccedono in positivo o in negativo la grandezza della matrice
                for (let i = 0; i < mossePossibili.length; i++) {
                    let mossaX = mossePossibili[i][0];
                    let mossaY = mossePossibili[i][1];
                    if (mossaX < 0 || mossaX >= matrice.length || mossaY < 0 || mossaY >= matrice.length) {
                        mossePossibili.splice(i, 1);
                        i--;
                    }
                }
                // Colora le caselle disponibili per la mossa, non le colora se sono già cliccate
                for (let i = 0; i < mossePossibili.length; i++) {
                    let mossaX = mossePossibili[i][0];
                    let mossaY = mossePossibili[i][1];
                    if (matrice[mossaX][mossaY].style.backgroundColor == "blue") {
                        matrice[mossaX][mossaY].style.backgroundColor = "blue";
                    }
                    else {
                        matrice[mossaX][mossaY].style.backgroundColor = "red";
                    }                
                }
            }
        }

        function calcolaVittoria(caselleCliccate, matrice) {
            let indice = 0;
            if (caselleCliccate.length === matrice.length * matrice.length) {
                alert("Hai vinto!");
                return true;
            }
            for (let i = 0; i < matrice.length; i++) {
                for (let j = 0; j < matrice.length; j++) {
                    if (matrice[i][j].style.backgroundColor === "red") {
                        indice ++;
                    }
                }
            }
            if (indice === 0){
                alert("Hai perso!");
                return true;
            }
        }

        let matrice = creaMatrice(grandezzaMatrice);

        for (let i = 0; i < matrice.length; i++) {
            for (let j = 0; j < matrice.length; j++) {
                matrice[i][j].addEventListener("click", function () {
                    const colore = matrice[i][j].style.backgroundColor;
                    // Prima mossa: qualsiasi casella può essere cliccata
                    if (caselleCliccate.length === 0) {
                        mostraMossePossibili(matrice[i][j], matrice, caselleCliccate);
                    }
                    // Dalla seconda mossa in poi: solo le caselle rosse sono cliccabili
                    else if (colore === "red") {
                        mostraMossePossibili(matrice[i][j], matrice, caselleCliccate);
                        if (calcolaVittoria(caselleCliccate, matrice)) {
                            for (let i = 0; i < matrice.length; i++) {
                                for (let j = 0; j < matrice.length; j++) {
                                    const casella = matrice[i][j];
                                    casella.style.backgroundColor = "black"; // Ripristina il colore originale   
                                    casella.textContent = " "; // Ripristina il testo originale
                                    caselleCliccate = [];
                                    counter = 1;
                                    mostraMossePossibili(matrice[i][j], matrice, caselleCliccate);
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>